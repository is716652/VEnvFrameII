# 虚拟环境移植指南

## 场景与问题

当将 Python 项目（包含虚拟环境）从一台机器复制到另一台机器时，由于 Python 安装路径与版本可能不同，虚拟环境可能无法正常工作或版本不匹配。

例如：
- 原机器 Python 路径：`C:\Users\is716\Python\Python312`
- 新机器 Python 路径：`C:\Python312` 或 `C:\Program Files\Python312`

这会导致虚拟环境中的 `pyvenv.cfg` 文件、Scripts 目录、激活脚本与 pip 启动器等与新环境不匹配。

## 核心要求

- 本项目严格要求 Python 3.12.8
- 推荐使用项目内提供的自动修复/构建脚本，避免手动操作遗漏

## 工具概览

项目提供以下工具用于修复/构建：

1) Python 脚本（推荐由批处理或 PowerShell 调用）
```
python ./Tools/fix_venv_path.py
```
2) 批处理脚本（Windows，推荐）
```
./fix_venv_path.bat
```
3) PowerShell 脚本（Windows）
```
./Tools/fix_venv_path.ps1
```
4) 一键构建/补全
```
./build_env.bat [mirror]
```
- mirror：tsinghua | aliyun | douban | ustc | default

## 使用步骤

### 0) 可选：编辑 venv_config.ini
在项目根目录配置：
- PYTHON312_HOME：Python 3.12.8 安装目录
- MIRROR：依赖安装镜像（tsinghua/aliyun/douban/ustc/default）

示例：
```
PYTHON312_HOME=C:\Python312
MIRROR=tsinghua
```

### 1) 运行修复（迁移后首选）
在项目根目录执行：
```
# 推荐
./fix_venv_path.bat

# 或
python ./Tools/fix_venv_path.py
```

### 2) 如修复失败或版本不一致，执行一键构建/补全
```
./build_env.bat [mirror]
```
- 精确寻找并仅使用 Python 3.12.8（优先读取 venv_config.ini 的 PYTHON312_HOME）
- 未找到时尝试使用 package/python-3.12.8-amd64.exe 自动安装
- 自动重建非 3.12.8 的旧虚拟环境并补全依赖

### 3) 激活并验证
```
./activate_env.bat
```
- 自动校验 Python 版本是否为 3.12.8
- 输出 Python 路径、版本、pip 信息、包数量与列表

## 修复过程说明（fix_venv_path）

修复脚本会自动执行以下操作：

1. 检测 Python 3.12.8 安装路径
   - 优先读取 venv_config.ini 的 PYTHON312_HOME 并严格验证 3.12.8
   - 搜索常见安装位置、py 启动器与常用命令（仅接受 3.12.8）

2. 修复虚拟环境配置
   - 更新 `pyvenv.cfg` 中的 home/executable/command 指向新环境
   - 修复 Scripts 目录中的 python.exe、pythonw.exe 来源与路径
   - 修正 Bash/CMD 激活脚本中的路径与提示
   - 重新生成/修复 pip 启动器，确保可用

3. 依赖校验与补全（可选）
   - 若项目存在 requirements.txt，会尝试安装/补全依赖
   - 镜像配置从 venv_config.ini 或 build_env.bat 的参数继承

4. 结果验证
   - 验证修复后的虚拟环境是否能正常工作

## 修复前后对比示例

### 修复前（pyvenv.cfg）
```ini
home = C:\Users\is716\Python\Python312
include-system-site-packages = false
version = 3.12.8
executable = C:\Users\is716\Python\Python312\python.exe
command = C:\Users\is716\Python\Python312\python.exe -m venv D:\CodeBuddy_projects\VEnvFrame\VEnvFrame-Env
```

### 修复后（pyvenv.cfg）
```ini
home = C:\Python312
include-system-site-packages = false
version = 3.12.8
executable = C:\Python312\python.exe
command = C:\Python312\python.exe -m venv D:\CodeBuddy_projects\VEnvFrame\VEnvFrame-Env
```

## 支持的 Python 路径与检测方式

- `C:\Python312\python.exe`
- `C:\Python\Python312\python.exe`
- `C:\Users\{用户名}\Python\Python312\python.exe`
- `C:\Users\{用户名}\AppData\Local\Programs\Python\Python312\python.exe`
- `C:\Program Files\Python312\python.exe`
- `C:\Program Files (x86)\Python312\python.exe`
- 通过 PATH 中的 python/python3/python3.12 或 py 启动器（均需严格为 3.12.8）

## 注意事项

1. Python 版本要求：目标机器必须为 Python 3.12.8（不符将提示重建）
2. 依赖包：修复脚本会尝试修复 pip 启动器并在存在 requirements.txt 时补全依赖；也可手动运行 ./build_env.bat
3. 权限：确保有足够权限修改虚拟环境文件
4. 备份：建议在修复前备份原始的 pyvenv.cfg 文件
5. 配置：若未找到 Python，请在 venv_config.ini 设置 PYTHON312_HOME 后重试

## 故障排除

- 找不到 Python 3.12.8
  - 手动安装或在 venv_config.ini 配置 PYTHON312_HOME
  - 也可执行 ./build_env.bat 自动安装/重建

- 版本不一致（例如 3.12.x 非 3.12.8）
  - 执行 ./build_env.bat 自动重建为 3.12.8

- 权限不足
  - 以管理员身份运行脚本或检查目录写入权限

- 修复后仍无法激活
  - 检查 Python 版本是否完全匹配
  - 查看激活脚本输出的诊断信息
  - 运行 ./build_env.bat 进行完整重建

## 激活修复后的虚拟环境

```
./activate_env.bat

# 验证
python --version
python -m pip list | find /c /v ""
```

## 总结

通过使用提供的一键修复与构建工具，可以快速解决虚拟环境在不同机器间移植的路径与版本问题，确保环境严格对齐到 Python 3.12.8，并自动补全依赖以提高可用性。