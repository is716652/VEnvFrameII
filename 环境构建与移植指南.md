# 环境构建与移植指南

## 1. 基本信息与硬性要求

- 语言与版本：Python 3.12.8（严格要求）
- 虚拟环境名称：VEnvFrame-Env（位于项目根目录）
- 推荐优先使用项目提供的自动脚本，确保版本一致性与依赖可用性。

## 2. 快速开始（首选自动化）

1) 可选：编辑 venv_config.ini（项目根目录）
- 支持的键：
  - PYTHON312_HOME：Python 3.12.8 的安装目录（包含 python.exe）
  - MIRROR：依赖安装镜像，支持 tsinghua/aliyun/douban/ustc/default

示例：
```ini
PYTHON312_HOME=C:\Python312
MIRROR=tsinghua
```

2) 一键构建/补全虚拟环境
```
./build_env.bat [mirror]
```
- mirror 可选：tsinghua | aliyun | douban | ustc | default（命令行参数优先级高于 venv_config.ini）
- 脚本特性：
  - 严格查找并仅使用 Python 3.12.8（优先读取 venv_config.ini 的 PYTHON312_HOME）
  - 若未找到，将尝试使用 package/python-3.12.8-amd64.exe 自动安装
  - 使用镜像进行 pip 安装，若镜像失败自动回退默认源重试
  - 如已有虚拟环境但版本不是 3.12.8，将自动重建

3) 激活虚拟环境
```
./activate_env.bat
```
- 启动后会自动校验当前环境 Python 版本是否为 3.12.8，并输出诊断信息（Python 路径/版本、pip 信息、已安装包数量）

4) 验证环境
```
where python
python -c "import sys; print('Python路径:', sys.executable)"
python -m pip --version
python -m pip list | find /c /v ""
```

## 3. 迁移与路径修复（跨机器移动首选）

当项目复制到新机器后，原虚拟环境可能因路径或版本不一致而失效。请使用修复工具：

- 推荐：
```
./fix_venv_path.bat
```
- 或使用 Python 脚本：
```
python ./Tools/fix_venv_path.py
```
- 可选（Windows PowerShell）：
```
./Tools/fix_venv_path.ps1
```
- 若修复失败或版本不一致，执行：
```
./build_env.bat [mirror]
```

修复内容：
- 更新 pyvenv.cfg（home/executable/command）
- 修复 Scripts 目录中的 python 启动器（python.exe/pythonw.exe）
- 修正 activate（bat/ps1/sh）脚本路径
- 重建 pip 启动器，确保可用
- 可选：检测 requirements.txt 并自动补全依赖（继承 MIRROR）

## 4. 手动方式（仅在了解严格版本要求时使用）

1) 创建虚拟环境（确保使用 Python 3.12.8）
```
python -m venv VEnvFrame-Env
```
2) 激活虚拟环境
- Windows (PowerShell):
```
./VEnvFrame-Env/Scripts/Activate.ps1
```
- Windows (CMD):
```
./VEnvFrame-Env/Scripts/activate.bat
```
- Linux/macOS:
```
source ./VEnvFrame-Env/bin/activate
```
3) 安装依赖
- 使用国内镜像源（例如清华源）
```
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```
- 或使用默认源
```
pip install -r requirements.txt
```

## 5. 修复过程说明（fix_venv_path）

1) 检测 Python 3.12.8 安装路径
- 优先读取 venv_config.ini 的 PYTHON312_HOME 并严格验证版本
- 搜索常见安装位置、py 启动器、PATH 中的 python（均需严格为 3.12.8）

2) 修复虚拟环境配置
- 更新 `pyvenv.cfg` 中的 home/executable/command 指向新环境
- 修复 Scripts 目录中的 python.exe、pythonw.exe 来源与路径
- 修正 Bash/CMD/PowerShell 激活脚本中的路径
- 重新生成/修复 pip 启动器，确保可用

3) 依赖校验与补全（可选）
- 若项目存在 requirements.txt，会尝试安装/补全依赖
- 镜像配置从 venv_config.ini 或 build_env.bat 的参数继承

4) 结果验证
- 验证修复后的虚拟环境是否能正常工作，输出版本与已安装包统计

示例（pyvenv.cfg 修复前/后）：

修复前：
```ini
home = C:\Users\user\Python\Python312
include-system-site-packages = false
version = 3.12.8
executable = C:\Users\user\Python\Python312\python.exe
command = C:\Users\user\Python\Python312\python.exe -m venv D:\VEnvFrameII\VEnvFrame-Env
```

修复后：
```ini
home = C:\Python312
include-system-site-packages = false
version = 3.12.8
executable = C:\Python312\python.exe
command = C:\Python312\python.exe -m venv D:\VEnvFrameII\VEnvFrame-Env
```

## 6. 支持的 Python 路径与检测方式

- C:\\Python312\\python.exe
- C:\\Python\\Python312\\python.exe
- C:\\Users\\{用户名}\\Python\\Python312\\python.exe
- C:\\Users\\{用户名}\\AppData\\Local\\Programs\\Python\\Python312\\python.exe
- C:\\Program Files\\Python312\\python.exe
- C:\\Program Files (x86)\\Python312\\python.exe
- 通过 PATH/py 启动器找到的 python（需严格为 3.12.8）

## 7. 常用命令速查

- 升级基础构建工具（镜像可选）
```
python -m pip install -U pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
```
- 安装依赖（镜像 + 回退）
```
python -m pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```
- 统计已安装包数量
```
python -m pip list | find /c /v ""
```
- 删除并重建虚拟环境
```
Remove-Item -Recurse -Force ./VEnvFrame-Env
python -m venv VEnvFrame-Env
```

## 8. 故障排除（结合最佳实践）

- Python 版本不匹配（非 3.12.8）
  - 运行 `./build_env.bat` 自动重建为 3.12.8
- 迁移后无法激活或路径错误
  - 运行 `./fix_venv_path.bat` 修复路径；仍有异常则执行 `./build_env.bat [mirror]`
- PowerShell 中使用 `&&`/`||` 导致错误
  - 在 PowerShell 中使用 `; if ($LASTEXITCODE -eq 0) { ... } else { ... }` 或通过 `cmd /c` 调用命令
- 初次 venv 中出现 `.pth` 相关报错
  - 删除虚拟环境目录并用 3.12.8 重新创建，再安装依赖
- 未配置 PYTHON312_HOME 导致自动脚本不稳定
  - 在 `venv_config.ini` 中明确设置 Python 3.12.8 安装目录
- PowerShell 脚本编码/语法问题
  - 若 `Tools/fix_venv_path.ps1` 报语法错误，优先使用 `fix_venv_path.bat` 或 `python Tools/fix_venv_path.py`

## 9. 注意事项

- 所有开发工作必须在激活虚拟环境后进行
- 安装依赖时务必使用虚拟环境内的 pip，避免污染系统 Python
- 路径/版本多次确认：where python、pip --version、包统计
- 将 `VEnvFrame-Env/` 加入 `.gitignore`，确保团队一致性（Python 3.12.8 + 同一套依赖）

## 10. 激活后快速验证
```
./activate_env.bat
python --version
python -m pip --version
python -m pip list | find /c /v ""
```

---
本指南合并自《第一步-虚拟环境构建-系统提示词模板.md》与《虚拟环境移植指南.md》，并统一口径为 VEnvFrameII 的环境构建与移植权威文档。